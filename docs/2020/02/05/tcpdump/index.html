<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="...">
    <meta name="keyword" content="undefined">
    <meta name="theme-color" content="#000000"><!-- 600090 -->
    <meta name="msapplication-navbutton-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#000000">
    <link rel="shortcut icon" href="https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png">
    <link rel="alternate" type="application/atom+xml" title="Bluse" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        tcpdump 使用技巧｜Bluse
        
    </title>

    <link rel="canonical" href="https://www.wangjunfeng.com.cn/2020/02/05/tcpdump/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/blog-style.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
</head>

<style>

    header.intro-header {
        background-image: url('https://www.sslcentral.com/wp-content/uploads/2014/09/sld1.jpg')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    Bluse
                </span>
                Programing Thinker
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
					
                    
                        
							
                        <li>
                            <a href="/finance/">互联网价值</a>
                        </li>
							
						
                    
                        
							
                        <li>
                            <a href="/pg/">PG Driver</a>
                        </li>
							
						
                    
                        
							
                        <li>
                            <a href="/tags/">tags</a>
                        </li>
							
						
                    
					
					
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="https://user-images.githubusercontent.com/1764005/68638684-452de100-053d-11ea-8ea3-18f7ea73cf1f.png">


<style>
    
    header.intro-header {
        background-image: url('https://user-images.githubusercontent.com/1764005/68638684-452de100-053d-11ea-8ea3-18f7ea73cf1f.png')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>tcpdump 使用技巧</h1>
                    
                    <span class="meta">
                         作者 bluse wang
                        <span>
                          日期 2020-02-05
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                        <a class="tag" href="/tags/#net"
                           title="net">net</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            tcpdump 使用技巧
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <p>一般情况下，非HTTP协议的网络分析，在服务器端用<code>tcpdump</code>比较多，在客户端用wireshark比较多，两个抓包软件的语法是一样的。</p>
<h2 id="一、基本语法"><a href="#一、基本语法" class="headerlink" title="一、基本语法"></a>一、基本语法</h2><h3 id="1-1、过滤主机"><a href="#1-1、过滤主机" class="headerlink" title="1.1、过滤主机"></a>1.1、过滤主机</h3><ul>
<li>抓取所有经过eth1，目的或源地址是192.168.1.1的网络数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 host 192.168.1.1</span><br></pre></td></tr></table></figure>

<ul>
<li>指定源地址</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 src host 192.168.1.1</span><br></pre></td></tr></table></figure>

<ul>
<li>指定目的地址</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 dst host 192.168.1.1</span><br></pre></td></tr></table></figure>

<h3 id="1-2、过滤端口"><a href="#1-2、过滤端口" class="headerlink" title="1.2、过滤端口"></a>1.2、过滤端口</h3><ul>
<li>抓取所有经过eth1，目的或源端口是25的网络数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 port 25</span><br></pre></td></tr></table></figure>

<ul>
<li>指定源端口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 src port 25</span><br></pre></td></tr></table></figure>

<ul>
<li>指定目的端口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 dst port 25</span><br></pre></td></tr></table></figure>

<h3 id="1-3、网络过滤"><a href="#1-3、网络过滤" class="headerlink" title="1.3、网络过滤"></a>1.3、网络过滤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 net 192.168</span><br><span class="line">tcpdump -i eth1 src net 192.168</span><br><span class="line">tcpdump -i eth1 dst net 192.168</span><br></pre></td></tr></table></figure>

<h3 id="1-4、协议过滤"><a href="#1-4、协议过滤" class="headerlink" title="1.4、协议过滤"></a>1.4、协议过滤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 arp</span><br><span class="line">tcpdump -i eth1 ip</span><br><span class="line">tcpdump -i eth1 tcp</span><br><span class="line">tcpdump -i eth1 udp</span><br><span class="line">tcpdump -i eth1 icmp</span><br></pre></td></tr></table></figure>

<h3 id="1-5、常用表达式"><a href="#1-5、常用表达式" class="headerlink" title="1.5、常用表达式"></a>1.5、常用表达式</h3><pre><code>非 : ! or &quot;not&quot; (去掉双引号)  
且 : &amp;&amp; or &quot;and&quot;  
或 : || or &quot;or&quot;  </code></pre><ul>
<li>抓取所有经过eth1，目的地址是192.168.1.254或192.168.1.200端口是80的TCP数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'((tcp) and (port 80) and ((dst host 192.168.1.254) or (dst host 192.168.1.200)))'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>抓取所有经过eth1，目标MAC地址是00:01:02:03:04:05的ICMP数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'((icmp) and ((ether dst host 00:01:02:03:04:05)))'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>抓取所有经过eth1，目的网络是192.168，但目的主机不是192.168.1.200的TCP数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'((tcp) and ((dst net 192.168) and (not dst host 192.168.1.200)))'</span></span><br></pre></td></tr></table></figure>

<h2 id="二、高级包头过滤"><a href="#二、高级包头过滤" class="headerlink" title="二、高级包头过滤"></a>二、高级包头过滤</h2><p>首先了解如何从包头过滤信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proto[x:y]          : 过滤从x字节开始的y字节数。比如ip[2:2]过滤出3、4字节（第一字节从0开始排）</span><br><span class="line">proto[x:y] &amp; z = 0  : proto[x:y]和z的与操作为0</span><br><span class="line">proto[x:y] &amp; z !=0  : proto[x:y]和z的与操作不为0</span><br><span class="line">proto[x:y] &amp; z = z  : proto[x:y]和z的与操作为z</span><br><span class="line">proto[x:y] = z      : proto[x:y]等于z</span><br></pre></td></tr></table></figure>

<p>操作符 : &gt;, &lt;, &gt;=, &lt;=, =, !=</p>
<h3 id="2-1、IP头"><a href="#2-1、IP头" class="headerlink" title="2.1、IP头"></a>2.1、IP头</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|Version|  IHL  |Type of Service|          Total Length         |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|         Identification        |Flags|      Fragment Offset    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Time to Live |    Protocol   |         Header Checksum       |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                       Source Address                          |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Destination Address                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Options                    |    Padding    | &lt;-- optional</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                            DATA ...                           |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<p>本文只针对IPv4。</p>
<h3 id="2-2、Flags"><a href="#2-2、Flags" class="headerlink" title="2.2、Flags"></a>2.2、Flags</h3><table>
<thead>
<tr>
<th align="left">TCP Flag</th>
<th align="left">tcpdump Flag</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SYN</td>
<td align="left">S</td>
<td align="left">Syn数据包，会话建立请求。</td>
</tr>
<tr>
<td align="left">ACK</td>
<td align="left">A</td>
<td align="left">Ack数据包，确认发送端的数据。</td>
</tr>
<tr>
<td align="left">FIN</td>
<td align="left">F</td>
<td align="left">结束标记，终止指示。</td>
</tr>
<tr>
<td align="left">RESET</td>
<td align="left">R</td>
<td align="left">重置，指示立即终止连接。</td>
</tr>
<tr>
<td align="left">PUSH</td>
<td align="left">P</td>
<td align="left">推送，立即将缓存中的数据发完。</td>
</tr>
<tr>
<td align="left">URGENT</td>
<td align="left">U</td>
<td align="left">紧急，优先于其他数据。</td>
</tr>
<tr>
<td align="left">NONE</td>
<td align="left">.</td>
<td align="left">占位符，通常用于ACK。</td>
</tr>
</tbody></table>
<h3 id="2-3、IP选项设置了吗？"><a href="#2-3、IP选项设置了吗？" class="headerlink" title="2.3、IP选项设置了吗？"></a>2.3、IP选项设置了吗？</h3><p>“一般”的IP头是20字节，但IP头有选项设置，不能直接从偏移21字节处读取数据。IP头有个长度字段可以知道头长度是否大于20字节。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+</span><br><span class="line">|Version|  IHL  |</span><br><span class="line">+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<p>通常第一个字节的二进制值是：01000101，分成两个部分：</p>
<p>0100 = 4 表示IP版本<br>0101 = 5 表示IP头32 bit的块数，5 x 32 bits = 160 bits or 20 bytes</p>
<p>如果第一字节第二部分的值大于5，那么表示头有IP选项。</p>
<p>下面介绍两种过滤方法（第一种方法比较操蛋，可忽略）：</p>
<p>a. 比较第一字节的值是否大于01000101，这可以判断IPv4带IP选项的数据和IPv6的数据。</p>
<p>01000101十进制等于69，计算方法如下（小提示：用计算器更方便）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0 : 0  \</span><br><span class="line">1 : 2^6 = 64 \ 第一部分 (IP版本)</span><br><span class="line">0 : 0   /</span><br><span class="line">0 : 0  /</span><br><span class="line">-</span><br><span class="line">0 : 0  \</span><br><span class="line">1 : 2^2 = 4  \ 第二部分 (头长度)</span><br><span class="line">0 : 0   /</span><br><span class="line">1 : 2^0 = 1 /</span><br></pre></td></tr></table></figure>

<p>64 + 4 + 1 = 69</p>
<p>如果设置了IP选项，那么第一自己是01000110（十进制70），过滤规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'ip[0] &gt; 69'</span></span><br></pre></td></tr></table></figure>

<p>IPv6的数据也会匹配，看看第二种方法。</p>
<p>b. 位操作</p>
<p>0100 0101 : 第一字节的二进制<br>0000 1111 : 与操作<br>&lt;=========<br>0000 0101 : 结果  </p>
<p>正确的过滤方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'ip[0] &amp; 15 &gt; 5'</span></span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'ip[0] &amp; 0x0f &gt; 5'</span></span><br></pre></td></tr></table></figure>

<h3 id="2-4、分片标记"><a href="#2-4、分片标记" class="headerlink" title="2.4、分片标记"></a>2.4、分片标记</h3><p>当发送端的MTU大于到目的路径链路上的MTU时就会被分片，这段话有点拗口，权威的请参考《TCP/IP详解》。唉，32借我的书没还，只能凑合写，大家记得看书啊。</p>
<p>分片信息在IP头的第七和第八字节：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|Flags|      Fragment Offset    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<p>Bit 0:  保留，必须是0<br>Bit 1:  (DF) 0 = 可能分片, 1 = 不分片<br>Bit 2:  (MF) 0 = 最后的分片, 1 = 还有分片  </p>
<p>Fragment Offset字段只有在分片的时候才使用。</p>
<p>要抓带DF位标记的不分片的包，第七字节的值应该是：</p>
<p>01000000 = 64</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'ip[6] = 64'</span></span><br></pre></td></tr></table></figure>

<h3 id="2-5、抓分片包"><a href="#2-5、抓分片包" class="headerlink" title="2.5、抓分片包"></a>2.5、抓分片包</h3><ul>
<li>匹配MF，分片包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'ip[6] = 32'</span></span><br></pre></td></tr></table></figure>

<p>最后分片包的开始3位是0，但是有Fragment Offset字段。</p>
<ul>
<li>匹配分片和最后分片</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'((ip[6:2] &gt; 0) and (not ip[6] = 64))'</span></span><br></pre></td></tr></table></figure>

<p>测试分片可以用下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping -M want -s 3000 192.168.1.1</span><br></pre></td></tr></table></figure>

<h3 id="2-6、匹配小TTL"><a href="#2-6、匹配小TTL" class="headerlink" title="2.6、匹配小TTL"></a>2.6、匹配小TTL</h3><p>TTL字段在第九字节，并且正好是完整的一个字节，TTL最大值是255，二进制为11111111。</p>
<p>可以用下面的命令验证一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ping -M want -s 3000 -t 256 192.168.1.200</span><br><span class="line">ping: ttl 256 out of range</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Time to Live |</span><br><span class="line">+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<ul>
<li>在网关可以用下面的命令看看网络中谁在使用traceroute</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'ip[8] &lt; 5'</span></span><br></pre></td></tr></table></figure>

<h3 id="2-7、抓大于X字节的包"><a href="#2-7、抓大于X字节的包" class="headerlink" title="2.7、抓大于X字节的包"></a>2.7、抓大于X字节的包</h3><ul>
<li>大于600字节</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'ip[2:2] &gt; 600'</span></span><br></pre></td></tr></table></figure>

<h3 id="2-8、更多的IP过滤"><a href="#2-8、更多的IP过滤" class="headerlink" title="2.8、更多的IP过滤"></a>2.8、更多的IP过滤</h3><p>首先还是需要知道TCP基本结构，再次推荐《TCP/IP详解》，卷一就够看的了，避免走火入魔。</p>
<ul>
<li>TCP头</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">0                   1                   2                   3</span><br><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|          Source Port          |       Destination Port        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                        Sequence Number                        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Acknowledgment Number                      |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|  Data |       |C|E|U|A|P|R|S|F|                               |</span><br><span class="line">| Offset|  Res. |W|C|R|C|S|S|Y|I|            Window             |</span><br><span class="line">|       |       |R|E|G|K|H|T|N|N|                               |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|           Checksum            |         Urgent Pointer        |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                    Options                    |    Padding    |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">|                             data                              |</span><br><span class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<ul>
<li>抓取源端口大于1024的TCP数据包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[0:2] &gt; 1024'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>匹配TCP数据包的特殊标记</li>
</ul>
<p>TCP标记定义在TCP头的第十四个字节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-+-+-+-+-+-+-+-+</span><br><span class="line">|C|E|U|A|P|R|S|F|</span><br><span class="line">|W|C|R|C|S|S|Y|I|</span><br><span class="line">|R|E|G|K|H|T|N|N|</span><br><span class="line">+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<p>重复一下TCP三次握手，两个主机是如何勾搭的：</p>
<ol>
<li>源发送SYN</li>
<li>目标回答SYN, ACK</li>
<li>源发送ACK</li>
</ol>
<p>没女朋友的童鞋要学习一下：  </p>
<ol>
<li>MM，你的手有空吗？-_-  </li>
<li>有空，你呢？~_~  </li>
<li>我也有空 *_*  </li>
</ol>
<p>失败的loser是酱紫的：  </p>
<ol>
<li>MM，这是你掉的板砖吗？(SYN) ￣▽￣  </li>
<li>不是，找拍啊？(RST-ACK) ˋ﹏ˊ  </li>
</ol>
<ul>
<li>只抓SYN包，第十四字节是二进制的00000010，也就是十进制的2</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[13] = 2'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>抓SYN, ACK （00010010 or 18）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[13] = 18'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>抓SYN或者SYN-ACK</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[13] &amp; 2 = 2'</span></span><br></pre></td></tr></table></figure>

<p>用到了位操作，就是不管ACK位是啥。</p>
<ul>
<li>抓PSH-ACK</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[13] = 24'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>抓所有包含FIN标记的包（FIN通常和ACK一起，表示幽会完了，回见）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[13] &amp; 1 = 1'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>抓RST（勾搭没成功，伟大的greatwall对她认为有敏感信息的连接发RST包，典型的棒打鸳鸯）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[13] &amp; 4 = 4'</span></span><br></pre></td></tr></table></figure>

<p>下图详细描述了TCP各种状态的标记，方便分析。</p>
<p><img src="https://raw.githubusercontent.com/linuxwiki/SourceWiki/master/images/tcp_state_machine.jpg" alt="tcp_state_machine.jpg"></p>
<h3 id="2-9、大叔注"><a href="#2-9、大叔注" class="headerlink" title="2.9、大叔注"></a>2.9、大叔注</h3><p>tcpdump考虑了一些数字恐惧症者的需求，提供了部分常用的字段偏移名字：</p>
<p>icmptype  (ICMP类型字段)<br>icmpcode  (ICMP符号字段)<br>tcpflags  (TCP标记字段)  </p>
<p>ICMP类型值有：</p>
<p>icmp-echoreply, icmp-unreach, icmp-sourcequench, icmp-redirect, icmp-echo, icmp-routeradvert, icmp-routersolicit, icmp-timxceed, icmp-paramprob, icmp-tstamp, icmp-tstampreply, icmp-ireq, icmp-ireqreply, icmp-maskreq, icmp-maskreply</p>
<p>TCP标记值：</p>
<p>tcp-fin, tcp-syn, tcp-rst, tcp-push, tcp-push, tcp-ack, tcp-urg</p>
<p>这样上面按照TCP标记位抓包的就可以写直观的表达式了：</p>
<ul>
<li>只抓SYN包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[tcpflags] = tcp-syn'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>抓SYN, ACK</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[tcpflags] &amp; tcp-syn != 0 and tcp[tcpflags] &amp; tcp-ack != 0'</span></span><br></pre></td></tr></table></figure>

<h3 id="2-10、抓SMTP数据"><a href="#2-10、抓SMTP数据" class="headerlink" title="2.10、抓SMTP数据"></a>2.10、抓SMTP数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'((port 25) and (tcp[(tcp[12]&gt;&gt;2):4] = 0x4d41494c))'</span></span><br></pre></td></tr></table></figure>

<p>抓取数据区开始为”MAIL”的包，”MAIL”的十六进制为0x4d41494c。</p>
<h3 id="2-11、抓HTTP-GET数据"><a href="#2-11、抓HTTP-GET数据" class="headerlink" title="2.11、抓HTTP GET数据"></a>2.11、抓HTTP GET数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[(tcp[12]&gt;&gt;2):4] = 0x47455420'</span></span><br></pre></td></tr></table></figure>

<p>“GET “的十六进制是47455420</p>
<h3 id="2-12、抓SSH返回"><a href="#2-12、抓SSH返回" class="headerlink" title="2.12、抓SSH返回"></a>2.12、抓SSH返回</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'tcp[(tcp[12]&gt;&gt;2):4] = 0x5353482D'</span></span><br></pre></td></tr></table></figure>

<p>“SSH-“的十六进制是0x5353482D</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 <span class="string">'(tcp[(tcp[12]&gt;&gt;2):4] = 0x5353482D) and (tcp[((tcp[12]&gt;&gt;2)+4):2] = 0x312E)'</span></span><br></pre></td></tr></table></figure>

<p>抓老版本的SSH返回信息，如”SSH-1.99..”</p>
<h2 id="三、大叔注"><a href="#三、大叔注" class="headerlink" title="三、大叔注"></a>三、大叔注</h2><p>如果是为了查看数据内容，建议用<code>tcpdump -s 0 -w filename</code>把数据包都保存下来，然后用wireshark的Follow TCP Stream/Follow UDP Stream来查看整个会话的内容。</p>
<p><code>-s 0</code>是抓取完整数据包，否则默认只抓68字节。</p>
<p>另外，用tcpflow也可以方便的获取TCP会话内容，支持tcpdump的各种表达式。</p>
<h3 id="3-1、UDP头"><a href="#3-1、UDP头" class="headerlink" title="3.1、UDP头"></a>3.1、UDP头</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> 0      7 8     15 16    23 24    31</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|     Source      |   Destination   |</span><br><span class="line">|      Port       |      Port       |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|                 |                 |</span><br><span class="line">|     Length      |    Checksum     |</span><br><span class="line">+--------+--------+--------+--------+</span><br><span class="line">|                                   |</span><br><span class="line">|              DATA ...             |</span><br><span class="line">+-----------------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>抓DNS请求数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i eth1 udp dst port 53</span><br></pre></td></tr></table></figure>

<h3 id="3-2、其他"><a href="#3-2、其他" class="headerlink" title="3.2、其他"></a>3.2、其他</h3><p><code>-c</code>参数对于运维人员来说也比较常用，因为流量比较大的服务器，靠人工CTRL+C还是抓的太多，甚至导致服务器宕机，于是可以用<code>-c</code>参数指定抓多少个包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time tcpdump -nn -i eth0 <span class="string">'tcp[tcpflags] = tcp-syn'</span> -c 10000 &gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>上面的命令计算抓10000个SYN包花费多少时间，可以判断访问量大概是多少。</p>
<h2 id="四、参考资料"><a href="#四、参考资料" class="headerlink" title="四、参考资料"></a>四、参考资料</h2><blockquote>
<p><a href="http://www.wains.be/pub/networking/tcpdump_advanced_filters.txt" target="_blank" rel="noopener">tcpdump advanced filters</a></p>
</blockquote>

                <hr>
                

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2020/03/10/java-async-sync/" data-toggle="tooltip" data-placement="top"
                           title="Java多个异步任务转同步">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2019/12/14/iptables/" data-toggle="tooltip" data-placement="top"
                           title="iptables详细教程：基础、架构、清空规则、追加规则、应用实例">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                

                

            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、基本语法"><span class="toc-text">一、基本语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1、过滤主机"><span class="toc-text">1.1、过滤主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2、过滤端口"><span class="toc-text">1.2、过滤端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3、网络过滤"><span class="toc-text">1.3、网络过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4、协议过滤"><span class="toc-text">1.4、协议过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5、常用表达式"><span class="toc-text">1.5、常用表达式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、高级包头过滤"><span class="toc-text">二、高级包头过滤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1、IP头"><span class="toc-text">2.1、IP头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2、Flags"><span class="toc-text">2.2、Flags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3、IP选项设置了吗？"><span class="toc-text">2.3、IP选项设置了吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4、分片标记"><span class="toc-text">2.4、分片标记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5、抓分片包"><span class="toc-text">2.5、抓分片包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6、匹配小TTL"><span class="toc-text">2.6、匹配小TTL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7、抓大于X字节的包"><span class="toc-text">2.7、抓大于X字节的包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8、更多的IP过滤"><span class="toc-text">2.8、更多的IP过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9、大叔注"><span class="toc-text">2.9、大叔注</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10、抓SMTP数据"><span class="toc-text">2.10、抓SMTP数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11、抓HTTP-GET数据"><span class="toc-text">2.11、抓HTTP GET数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-12、抓SSH返回"><span class="toc-text">2.12、抓SSH返回</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、大叔注"><span class="toc-text">三、大叔注</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1、UDP头"><span class="toc-text">3.1、UDP头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2、其他"><span class="toc-text">3.2、其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、参考资料"><span class="toc-text">四、参考资料</span></a></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                

                <!-- Friends Blog -->
                
                <div style="margin-top: 20px;">
                    <h5 class="text-center">FRIENDS</h5>
                    <ul class="list-inline text-center">
                        
                        <li><a href="https://ruff.io/zh-cn/">ruff</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>

    </div>
</article>






<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/blusewang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    &copy; 2020 Bluse
                    <span id="busuanzi_container_site_pv" style="font-size: 12px;">PV: <span id="busuanzi_value_site_pv"></span> </span>
                    备案号：京ICP备13038498号-1 Power by <a href="https://hexo.io" target="_blank">hexo</a> Theme by <a href="https://haojen.github.io/" target="_blank">Haojen Ma</a>
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/blog.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://www.wangjunfeng.com.cn/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->



<!-- Baidu Tongji -->


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','null','2.0.0');
</script>

<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!--wechat title img-->
<img class="wechat-title-img" src="https://avatars0.githubusercontent.com/u/1764005?v=3&amp;s=460">
</body>

</html>
